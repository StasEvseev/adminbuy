
<div class="panel panel-default top-bar">
    <div class="panel-heading">
        <top-panel breadcrumbs="breadcrumbs">
            <div class="col-md-8">
                <button type="button" class="btn btn-sm btn-danger" ng-click="nextStep()">Сформировать накладную</button>
            </div>
        </top-panel>
    </div>
</div>

<div class="form-bg">
    <div class="form-sheet">
        <div style="margin-bottom: 20px">
            <div class="row">
                <div class="form-group" ng-class="{'has-error': model.errors.date}">
                    <div class="col-xs-5 bordered-right">
                        <label class="">Дата</label>
                    </div>
                    <div class="col-xs-7">
                        <p class="input-group" ng-class="{'has-error': model.validate.date_empty == true,
                                                      'has-success': !model.validate.date_empty == false}">
                            <input type="text" class="form-control"
                                 datepicker-popup="{{model.date.format}}"
                                 ng-model="model.date.dt"
                                 is-open="model.date.opened"
                                 min-date="model.date.minDate"
                                 max-date="model.date.maxDate"
                                 datepicker-options="model.date.dateOptions"
                                 date-disabled="model.date.disabled(date, mode)" ng-required="true"
                                 close-text="Закрыть" />
                            <span class="input-group-btn">
                                <button type="button" class="btn btn-default" ng-click="model.date.open($event)"><i class="fa fa-calendar"></i></button>
                            </span>
                        </p>
                    </div>
                </div>
            </div>
            <div class="row" style="margin-bottom: 15px">
                <div class="col-xs-5 bordered-right" >
                    <label for="bla">Выберите кому</label>
                </div>
                <div class="col-xs-7">
                    <div class="btn-group">
                        <label class="btn btn-default" ng-model="model.typeT" btn-radio="1" uncheckable>Торговые точки</label>
                        <label class="btn btn-default" ng-model="model.typeT" btn-radio="2" uncheckable>Получатели</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group" ng-class="{'has-error': model.errors.point_or_receiver}">
                        <div ng-show="model.typeT == 1">
                            <dict-select-field label="Точка"
                                   placeholder="Выберите или поищите..."
                                   resource="resource_pointsale"
                                   attrdisplay="name"
                                   selected="model.selected_pointsale"
                                   clbkclose="loadCommodity"
                                   disabled="disabled">
                            </dict-select-field>
                        </div>

                        <div ng-show="model.typeT == 2">
                            <dict-select-field label="Получатель"
                                   placeholder="Выберите или поищите..."
                                   resource="resource_receiver"
                                   attrdisplay="fullname"
                                   selected="model.selected_receiver"
                                   clbkclose="loadCommodity"
                                   disabled="disabled">
                            </dict-select-field>
                        </div>

                </div>
            </div>
        </div>

        <tabset>
            <tab heading="Позиции накладной">
                <table class="table table-waybill">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            <th>Кол-во (в накл.)</th>
                            <th>Кол-во</th>
                            <th class="column_price" ng-show="typeInvoice == 1">Цена розницы</th>
                            <th class="column_price" ng-show="typeInvoice == 2">Цена опта</th>
                            <th class="column_price">Сумма</th>
                            <th ng-show="isActionClmn">Действия</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr ng-repeat="item in model.items">
                            <td >
                                <del ng-if="!item.is_approve">
                                    {{ item.full_name }}
                                </del>
                                <span ng-if="item.is_approve">
                                    {{ item.full_name }}
                                </span>
                            </td>
                            <td>
                                <input nks-only-number ng-model="item.count_invoice"
                                       ng-change="item.count_change(model.typeInvoice)"
                                       class="input-small input-table-sm"
                                       type="text"
                                       placeholder=""/>
                            </td>
                            <td>
                                {{ item.count }}
                            </td>
                            <td ng-show="typeInvoice == 1">
                                {{ item.price_retail | rub}}
                            </td>
                            <td ng-show="typeInvoice == 2">
                                {{ item.price_gross | rub}}
                            </td>
                            <td>
                                {{ item.count_invoice * (typeInvoice == 1?item.price_retail:item.price_gross) | rub }}
                            </td>
                            <td ng-show="isActionClmn">
                                <span ng-hide="item.is_approve"><button popover="Нажмите, для того чтобы добавить позицию в накладную!"
                                                                        popover-trigger="mouseenter"
                                                                        ng-disabled="!item.is_can_approve"
                                                                        class="btn btn-success btn-block btn-xs"
                                                                        ng-click="addToInvoice(item, model.typeInvoice)">Добавить</button></span>

                                <span ng-hide="!item.is_approve"><button popover="Нажмите, для того чтобы убрать позицию из накладной!"
                                                                         popover-trigger="mouseenter" class="btn btn-danger btn-block btn-xs"
                                                                         ng-click="removeFromInvoice(item)">Убрать</button></span>
                            </td>

                        </tr>

                    </tbody>
                </table>
            </tab>
            <tab heading="Дополнительный товар">
                <table class="table table-waybill">
                    <thead>
                        <tr>
                            <th>Наименование</th>
                            <th>Количество</th>
                            <th>Цена с НДС</th>

                            <th class="column_price" ng-show="typeInvoice == 1">Цена розницы</th>
                            <th class="column_price" ng-show="typeInvoice == 2">Цена опта</th>
                            <th class="column_price">Сумма</th>

                            <th></th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr ng-repeat="item in model.items_extra" ng-click="editItem(item)" style="cursor:pointer;">

                            <td >
                                {{ item.full_name }}
                            </td>
                            <td>
                                {{ item.count_invoice }}
                            </td>
                            <td>
                                <span>
                                    {{ item.price_post | rub }}
                                </span>
                            </td>
                            <td ng-show="typeInvoice == 1">
                                <span>
                                    {{ item.price_retail | rub }}
                                </span>
                            </td>
                            <td ng-show="typeInvoice == 2">
                                <span>
                                    {{ item.price_gross | rub }}
                                </span>
                            </td>
                            <td>
                                {{ item.count_invoice * (typeInvoice == 1?item.price_retail:item.price_gross) | rub }}
                            </td>
                            <td ng-click="deleteItem(item)">
                                <i class="fa fa-trash-o"></i>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="8">
                                <a ng-click="openToAdd()" style="cursor:pointer; font-weight: bold">Добавить</a>
                            </td>
                        </tr>
                        <tr>
                            <td colspan="8">
                                &nbsp;
                            </td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr></tr>
                    </tfoot>
                </table>
            </tab>
        </tabset>
    </div>
</div>

